@page "{id}"
@model TGharker.Identity.Web.Pages.Dashboard.Clients.EditModel
@using TGHarker.Identity.Abstractions.Models
@{
    ViewData["Title"] = $"Edit {Model.Input.ClientName}";
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="./Index">Applications</a></li>
        <li class="breadcrumb-item"><a asp-page="./Details" asp-route-id="@Model.ClientId">@Model.Input.ClientName</a></li>
        <li class="breadcrumb-item active">Edit</li>
    </ol>
</nav>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">Edit Application</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-route-id="@Model.ClientId">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">Client ID</label>
                        <input type="text" class="form-control font-monospace" value="@Model.ClientId" readonly disabled />
                        <div class="form-text">Client ID cannot be changed after creation.</div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.ClientName" class="form-label">Application Name <span class="text-danger">*</span></label>
                        <input asp-for="Input.ClientName" class="form-control" />
                        <span asp-validation-for="Input.ClientName" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Application Type</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="form-check card h-100">
                                    <div class="card-body">
                                        <input class="form-check-input" type="radio" asp-for="Input.ApplicationType" value="spa" id="typeSpa" />
                                        <label class="form-check-label d-block" for="typeSpa">
                                            <i class="bi bi-window me-1"></i> <strong>Single Page App</strong>
                                            <div class="small text-muted">React, Angular, Vue</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card h-100">
                                    <div class="card-body">
                                        <input class="form-check-input" type="radio" asp-for="Input.ApplicationType" value="server" id="typeServer" />
                                        <label class="form-check-label d-block" for="typeServer">
                                            <i class="bi bi-hdd-rack me-1"></i> <strong>Server / Backend</strong>
                                            <div class="small text-muted">API, CLI, Service</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card h-100">
                                    <div class="card-body">
                                        <input class="form-check-input" type="radio" asp-for="Input.ApplicationType" value="native" id="typeNative" />
                                        <label class="form-check-label d-block" for="typeNative">
                                            <i class="bi bi-phone me-1"></i> <strong>Native / Mobile</strong>
                                            <div class="small text-muted">iOS, Android, Desktop</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">Changing the application type will update the allowed grant types. Changing to Server will generate a client secret if none exists.</div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Input.Description" class="form-label">Description</label>
                        <textarea asp-for="Input.Description" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="Input.Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Redirect URIs</label>
                        <div id="redirectUrisList" class="uri-list" data-name="Input.RedirectUris" data-placeholder="https://myapp.com/callback">
                            @foreach (var uri in Model.Input.RedirectUris.Where(u => !string.IsNullOrEmpty(u)))
                            {
                                <div class="input-group mb-2 uri-row">
                                    <input type="text" name="Input.RedirectUris" class="form-control font-monospace uri-input" value="@uri" placeholder="https://myapp.com/callback" />
                                    <button type="button" class="btn btn-outline-danger remove-uri" title="Remove"><i class="bi bi-x-lg"></i></button>
                                </div>
                            }
                            <div class="input-group mb-2 uri-row">
                                <input type="text" name="Input.RedirectUris" class="form-control font-monospace uri-input" placeholder="https://myapp.com/callback" />
                                <button type="button" class="btn btn-outline-danger remove-uri invisible" title="Remove"><i class="bi bi-x-lg"></i></button>
                            </div>
                        </div>
                        <div class="form-text">Users will be redirected here after authentication.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Allowed Scopes</label>
                        <div class="row">
                            @foreach (var scope in Model.AvailableScopes)
                            {
                                <div class="col-md-4 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="Input.AllowedScopes"
                                               value="@scope"
                                               id="scope_@scope"
                                               @(Model.Input.AllowedScopes.Contains(scope) ? "checked" : "") />
                                        <label class="form-check-label" for="scope_@scope">@scope</label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Security Settings</label>
                        <div class="form-check">
                            <input asp-for="Input.RequirePkce" class="form-check-input" />
                            <label asp-for="Input.RequirePkce" class="form-check-label">
                                Require PKCE
                            </label>
                            <div class="form-text">Proof Key for Code Exchange adds an extra layer of security.</div>
                        </div>
                        <div class="form-check mt-2">
                            <input asp-for="Input.RequireConsent" class="form-check-input" />
                            <label asp-for="Input.RequireConsent" class="form-check-label">
                                Require Consent
                            </label>
                            <div class="form-text">Users must approve access to their data before authentication completes.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Post Logout Redirect URIs</label>
                        <div id="postLogoutUrisList" class="uri-list" data-name="Input.PostLogoutRedirectUris" data-placeholder="https://myapp.com">
                            @foreach (var uri in Model.Input.PostLogoutRedirectUris.Where(u => !string.IsNullOrEmpty(u)))
                            {
                                <div class="input-group mb-2 uri-row">
                                    <input type="text" name="Input.PostLogoutRedirectUris" class="form-control font-monospace uri-input" value="@uri" placeholder="https://myapp.com" />
                                    <button type="button" class="btn btn-outline-danger remove-uri" title="Remove"><i class="bi bi-x-lg"></i></button>
                                </div>
                            }
                            <div class="input-group mb-2 uri-row">
                                <input type="text" name="Input.PostLogoutRedirectUris" class="form-control font-monospace uri-input" placeholder="https://myapp.com" />
                                <button type="button" class="btn btn-outline-danger remove-uri invisible" title="Remove"><i class="bi bi-x-lg"></i></button>
                            </div>
                        </div>
                        <div class="form-text">Users will be redirected here after logout.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">CORS Origins</label>
                        <div id="corsOriginsList" class="uri-list" data-name="Input.CorsOrigins" data-placeholder="https://myapp.com">
                            @foreach (var origin in Model.Input.CorsOrigins.Where(o => !string.IsNullOrEmpty(o)))
                            {
                                <div class="input-group mb-2 uri-row">
                                    <input type="text" name="Input.CorsOrigins" class="form-control font-monospace uri-input" value="@origin" placeholder="https://myapp.com" />
                                    <button type="button" class="btn btn-outline-danger remove-uri" title="Remove"><i class="bi bi-x-lg"></i></button>
                                </div>
                            }
                            <div class="input-group mb-2 uri-row">
                                <input type="text" name="Input.CorsOrigins" class="form-control font-monospace uri-input" placeholder="https://myapp.com" />
                                <button type="button" class="btn btn-outline-danger remove-uri invisible" title="Remove"><i class="bi bi-x-lg"></i></button>
                            </div>
                        </div>
                        <div class="form-text">Required for browser-based applications making API calls.</div>
                    </div>

                    <hr class="my-4" />

                    <h6 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>User Registration Flow</h6>

                    <div class="form-check form-switch mb-3">
                        <input asp-for="Input.OrganizationsEnabled" class="form-check-input" id="orgEnabled" />
                        <label asp-for="Input.OrganizationsEnabled" class="form-check-label">
                            Enable Organizations
                        </label>
                        <div class="form-text">Allow users to create or join organizations during registration.</div>
                    </div>

                    <div id="orgSettings" style="@(Model.Input.OrganizationsEnabled ? "" : "display: none;")">
                        <div class="mb-3">
                            <label asp-for="Input.OrganizationMode" class="form-label">Organization Mode</label>
                            <select asp-for="Input.OrganizationMode" class="form-select">
                                <option value="@OrganizationRegistrationMode.None">None - Don't create organizations</option>
                                <option value="@OrganizationRegistrationMode.AutoCreate">Auto Create - Create organization automatically</option>
                                <option value="@OrganizationRegistrationMode.Prompt">Prompt - Ask user for organization details</option>
                                <option value="@OrganizationRegistrationMode.OptionalPrompt">Optional Prompt - Let user optionally create organization</option>
                            </select>
                            <div class="form-text">How organizations are handled during user registration.</div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.DefaultOrganizationRole" class="form-label">Default Organization Role</label>
                            <select asp-for="Input.DefaultOrganizationRole" class="form-select">
                                <option value="@WellKnownOrganizationRoles.Owner">Owner - Full control</option>
                                <option value="@WellKnownOrganizationRoles.Admin">Admin - Administrative access</option>
                                <option value="@WellKnownOrganizationRoles.Member">Member - Standard member</option>
                            </select>
                            <div class="form-text">Role assigned to the user in their new organization.</div>
                        </div>

                        <div class="form-check mb-3">
                            <input asp-for="Input.RequireOrganizationName" class="form-check-input" />
                            <label asp-for="Input.RequireOrganizationName" class="form-check-label">
                                Require Organization Name
                            </label>
                            <div class="form-text">Only applies to Prompt mode.</div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.OrganizationNameLabel" class="form-label">Organization Field Label</label>
                            <input asp-for="Input.OrganizationNameLabel" class="form-control" placeholder="e.g., Company Name, Team Name" />
                            <div class="form-text">Custom label for the organization name field.</div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.OrganizationNamePlaceholder" class="form-label">Placeholder Text</label>
                            <input asp-for="Input.OrganizationNamePlaceholder" class="form-control" placeholder="e.g., Acme Inc." />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.OrganizationHelpText" class="form-label">Help Text</label>
                            <input asp-for="Input.OrganizationHelpText" class="form-control" placeholder="Optional help text shown below the field" />
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> Save Changes
                        </button>
                        <a asp-page="./Details" asp-route-id="@Model.ClientId" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i>About Scopes</h5>
            </div>
            <div class="card-body">
                <dl class="small mb-0">
                    <dt>openid</dt>
                    <dd class="text-muted">Required for OpenID Connect. Returns user's unique identifier.</dd>

                    <dt>profile</dt>
                    <dd class="text-muted">Access to basic profile info (name, picture, etc.)</dd>

                    <dt>email</dt>
                    <dd class="text-muted">Access to user's email address.</dd>

                    <dt>phone</dt>
                    <dd class="text-muted">Access to user's phone number.</dd>

                    <dt>address</dt>
                    <dd class="text-muted">Access to user's address information.</dd>

                    <dt>offline_access</dt>
                    <dd class="text-muted mb-0">Allows refresh tokens for long-lived sessions.</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById('orgEnabled').addEventListener('change', function() {
            document.getElementById('orgSettings').style.display = this.checked ? 'block' : 'none';
        });

        // Dynamic URI list handling
        document.querySelectorAll('.uri-list').forEach(function(list) {
            const name = list.dataset.name;
            const placeholder = list.dataset.placeholder;

            function updateRemoveButtons() {
                const rows = list.querySelectorAll('.uri-row');
                rows.forEach(function(row, index) {
                    const btn = row.querySelector('.remove-uri');
                    const input = row.querySelector('.uri-input');
                    // Show remove button if not the last row, or if it has a value
                    if (index < rows.length - 1) {
                        btn.classList.remove('invisible');
                    } else {
                        btn.classList.add('invisible');
                    }
                });
            }

            function addNewRow() {
                const newRow = document.createElement('div');
                newRow.className = 'input-group mb-2 uri-row';
                newRow.innerHTML = `
                    <input type="text" name="${name}" class="form-control font-monospace uri-input" placeholder="${placeholder}" />
                    <button type="button" class="btn btn-outline-danger remove-uri invisible" title="Remove"><i class="bi bi-x-lg"></i></button>
                `;
                list.appendChild(newRow);
                attachEventListeners(newRow);
                updateRemoveButtons();
            }

            function attachEventListeners(row) {
                const input = row.querySelector('.uri-input');
                const removeBtn = row.querySelector('.remove-uri');

                input.addEventListener('input', function() {
                    const rows = list.querySelectorAll('.uri-row');
                    const lastRow = rows[rows.length - 1];
                    const lastInput = lastRow.querySelector('.uri-input');

                    // If user typed in the last row, add a new empty row
                    if (this === lastInput && this.value.trim() !== '') {
                        addNewRow();
                    }
                    updateRemoveButtons();
                });

                removeBtn.addEventListener('click', function() {
                    row.remove();
                    updateRemoveButtons();
                    // Ensure there's always at least one empty row
                    const rows = list.querySelectorAll('.uri-row');
                    if (rows.length === 0) {
                        addNewRow();
                    }
                });
            }

            // Attach to existing rows
            list.querySelectorAll('.uri-row').forEach(attachEventListeners);
            updateRemoveButtons();
        });
    </script>
}
