@page
@model TGharker.Identity.Web.Pages.Docs.ApiReferenceModel
@{
    ViewData["Title"] = "API Reference";
    Layout = "_DocsLayout";
}

<h1>API Reference</h1>
<p class="lead">
    Complete reference for all TGHarker Identity API endpoints.
</p>

<div class="docs-callout docs-callout-info">
    <p>For interactive API exploration, visit the <a href="/swagger" target="_blank">Swagger UI</a>.</p>
</div>

<h2>Tenant Context</h2>
<p>
    TGHarker Identity is a multi-tenant system. <strong>All OAuth/OIDC endpoints require tenant context</strong>, which can be established using any of these methods (in priority order):
</p>

<h3>1. X-Tenant-Id Header</h3>
<p>
    Include the tenant identifier in a request header:
</p>
<pre><code>X-Tenant-Id: my-company</code></pre>

<h3>2. Subdomain</h3>
<p>
    Use a tenant-specific subdomain:
</p>
<pre><code>https://my-company.identity.example.com/connect/authorize?...</code></pre>

<h3>3. URL Path Prefix</h3>
<p>
    Include the tenant in the URL path:
</p>
<pre><code>https://identity.example.com/tenants/my-company/connect/authorize?...</code></pre>

<h3>4. Query Parameter (Recommended for OAuth)</h3>
<p>
    Add the <code>tenant</code> query parameter to your OAuth requests:
</p>
<pre><code>GET /connect/authorize?
  tenant=my-company
  &response_type=code
  &client_id=YOUR_CLIENT_ID
  &redirect_uri=https://yourapp.com/callback
  &scope=openid profile email
  ...</code></pre>

<div class="docs-callout docs-callout-warning">
    <p><strong>Required:</strong> You must specify the tenant when initiating the OAuth flow. Without tenant context, the authorize endpoint will return a <code>tenant_not_found</code> error.</p>
</div>

<h3>Tenant Claims in Tokens</h3>
<p>
    Once authenticated, tokens automatically include tenant context:
</p>
<pre><code>{
  "sub": "user-123",
  "tenant_id": "tenant-uuid",
  "tenant_identifier": "my-company",
  "tenant_roles": ["user", "admin"]
}</code></pre>
<table>
    <thead>
        <tr><th>Claim</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>tenant_id</code></td><td>string</td><td>The unique identifier (UUID) of the tenant</td></tr>
        <tr><td><code>tenant_identifier</code></td><td>string</td><td>The URL-friendly slug of the tenant (e.g., <code>my-company</code>)</td></tr>
        <tr><td><code>tenant_roles</code></td><td>array</td><td>User's roles within the tenant (e.g., <code>["owner", "admin"]</code>)</td></tr>
    </tbody>
</table>

<h2>OAuth 2.0 / OpenID Connect Endpoints</h2>

<h3><span class="endpoint-badge endpoint-get">GET</span> /.well-known/openid-configuration</h3>
<p>Returns the OpenID Connect discovery document with all endpoint URLs and supported features.</p>

<h3><span class="endpoint-badge endpoint-get">GET</span> /connect/authorize</h3>
<p>Authorization endpoint. Initiates the OAuth 2.0 authorization flow. <strong>Requires tenant context.</strong></p>
<table>
    <thead>
        <tr><th>Parameter</th><th>Required</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>tenant</code></td><td>Yes*</td><td>Tenant identifier (unless using header/subdomain)</td></tr>
        <tr><td><code>response_type</code></td><td>Yes</td><td><code>code</code> for authorization code flow</td></tr>
        <tr><td><code>client_id</code></td><td>Yes</td><td>Your application's client ID</td></tr>
        <tr><td><code>redirect_uri</code></td><td>Yes</td><td>Callback URL (must be registered)</td></tr>
        <tr><td><code>scope</code></td><td>Yes</td><td>Space-separated scopes</td></tr>
        <tr><td><code>state</code></td><td>Recommended</td><td>CSRF protection value</td></tr>
        <tr><td><code>code_challenge</code></td><td>Conditional</td><td>PKCE challenge (required if client enforces PKCE)</td></tr>
        <tr><td><code>code_challenge_method</code></td><td>Conditional</td><td><code>S256</code> or <code>plain</code></td></tr>
        <tr><td><code>nonce</code></td><td>Optional</td><td>String value for replay protection</td></tr>
        <tr><td><code>prompt</code></td><td>Optional</td><td><code>none</code>, <code>login</code>, or <code>consent</code></td></tr>
        <tr><td><code>login_hint</code></td><td>Optional</td><td>Pre-fill email on login form</td></tr>
    </tbody>
</table>

<h3><span class="endpoint-badge endpoint-post">POST</span> /connect/token</h3>
<p>Token endpoint. Exchange authorization codes or credentials for tokens.</p>
<table>
    <thead>
        <tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>grant_type</code></td><td>string</td><td><code>authorization_code</code>, <code>refresh_token</code>, or <code>client_credentials</code></td></tr>
        <tr><td><code>code</code></td><td>string</td><td>Authorization code (for authorization_code grant)</td></tr>
        <tr><td><code>redirect_uri</code></td><td>string</td><td>Must match the authorize request</td></tr>
        <tr><td><code>refresh_token</code></td><td>string</td><td>Refresh token (for refresh_token grant)</td></tr>
        <tr><td><code>code_verifier</code></td><td>string</td><td>PKCE verifier</td></tr>
    </tbody>
</table>

<h3><span class="endpoint-badge endpoint-get">GET</span> /connect/userinfo</h3>
<p>Returns claims about the authenticated user. Requires a valid access token.</p>
<pre><code>Authorization: Bearer {access_token}</code></pre>

<h3><span class="endpoint-badge endpoint-post">POST</span> /connect/revoke</h3>
<p>Revoke an access token or refresh token.</p>
<table>
    <thead>
        <tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>token</code></td><td>string</td><td>The token to revoke</td></tr>
        <tr><td><code>token_type_hint</code></td><td>string</td><td><code>access_token</code> or <code>refresh_token</code></td></tr>
    </tbody>
</table>

<h3><span class="endpoint-badge endpoint-post">POST</span> /connect/introspect</h3>
<p>Introspect a token to check its validity and retrieve metadata.</p>

<h2>Platform Stats API</h2>

<h3><span class="endpoint-badge endpoint-get">GET</span> /api/stats</h3>
<p>Returns public platform statistics. No authentication required.</p>

<h4>Response</h4>
<pre><code>{
  "total_users": 1250,
  "total_tenants": 48,
  "monthly_active_users": 892,
  "generated_at": "2026-01-29T12:00:00Z"
}</code></pre>

<h2>Tenant Management API</h2>

<h3><span class="endpoint-badge endpoint-post">POST</span> /api/tenants</h3>
<p>Create a new tenant. Requires authentication.</p>

<h4>Request Body</h4>
<pre><code>{
  "identifier": "my-company",
  "name": "My Company",
  "display_name": "My Company Inc."
}</code></pre>

<h3><span class="endpoint-badge endpoint-get">GET</span> /api/tenants/{identifier}</h3>
<p>Get tenant details by identifier. Public endpoint.</p>

<h4>Response</h4>
<pre><code>{
  "id": "tenant-uuid",
  "identifier": "my-company",
  "name": "My Company",
  "display_name": "My Company Inc.",
  "is_active": true
}</code></pre>

<h3><span class="endpoint-badge endpoint-post">POST</span> /api/tenants/{identifier}/members</h3>
<p>Add a member to a tenant. Requires admin authorization.</p>

<h4>Request Body</h4>
<pre><code>{
  "email": "user@example.com",
  "roles": ["user", "developer"]
}</code></pre>

<h3><span class="endpoint-badge endpoint-post">POST</span> /api/tenants/{identifier}/clients</h3>
<p>Create an OAuth client for a tenant. Requires admin authorization.</p>

<h4>Request Body</h4>
<pre><code>{
  "client_id": "my-app",
  "client_name": "My Application",
  "is_confidential": true,
  "require_pkce": true,
  "redirect_uris": ["https://myapp.com/callback"],
  "allowed_scopes": ["openid", "profile", "email"],
  "allowed_grant_types": ["authorization_code", "refresh_token"]
}</code></pre>

<h2>Error Responses</h2>
<p>All API errors follow a consistent format:</p>
<pre><code>{
  "error": "error_code",
  "error_description": "Human-readable description of the error"
}</code></pre>

<h3>Common Error Codes</h3>
<table>
    <thead>
        <tr><th>Code</th><th>HTTP Status</th><th>Description</th></tr>
    </thead>
    <tbody>
        <tr><td><code>invalid_request</code></td><td>400</td><td>Missing or invalid parameters</td></tr>
        <tr><td><code>invalid_client</code></td><td>401</td><td>Client authentication failed</td></tr>
        <tr><td><code>invalid_grant</code></td><td>400</td><td>Invalid authorization code or refresh token</td></tr>
        <tr><td><code>unauthorized_client</code></td><td>403</td><td>Client not authorized for this grant type</td></tr>
        <tr><td><code>access_denied</code></td><td>403</td><td>User denied authorization</td></tr>
        <tr><td><code>tenant_exists</code></td><td>409</td><td>Tenant identifier already in use</td></tr>
    </tbody>
</table>
