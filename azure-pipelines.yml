# Azure DevOps Pipeline for TGHarker.Identity
# Builds Docker images and deploys to Azure Container Apps
#
# Required Pipeline Variables (configure in Azure DevOps):
#   ACR_NAME                  - Azure Container Registry name
#   ACR_LOGIN_SERVER          - ACR login server URL
#   ACR_SERVICE_CONNECTION    - Service connection for ACR
#   AZURE_SERVICE_CONNECTION  - Service connection for Azure
#   RESOURCE_GROUP            - Target resource group
#   CONTAINER_APP_ENV         - Container Apps environment name
#   STORAGE_CONNECTION_STRING - Azure Storage connection string
#   POSTGRES_CONNECTION_STRING - PostgreSQL connection string
#   SUPERADMIN_USERNAME       - SuperAdmin login username
#   SUPERADMIN_PASSWORD       - SuperAdmin login password (mark as secret!)

trigger:
  branches:
    include:
      - master

variables:
  # Container Registry
  acrName: '$(ACR_NAME)'
  acrLoginServer: '$(ACR_LOGIN_SERVER)'

  # Container Apps
  resourceGroup: '$(RESOURCE_GROUP)'
  containerAppEnv: '$(CONTAINER_APP_ENV)'

  # Image names
  webImageName: 'identity-web'
  siloImageName: 'identity-silo'

  # Build configuration
  dockerfilePath_Web: 'TGharker.Identity.Web/Dockerfile'
  dockerfilePath_Silo: 'TGHarker.Identity.Silo/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Images'
    jobs:
      - job: BuildImages
        displayName: 'Build Docker Images'
        pool:
          name: 'Tylers'
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'

          - task: Docker@2
            displayName: 'Build Identity Web Image'
            inputs:
              command: build
              repository: '$(webImageName)'
              dockerfile: '$(dockerfilePath_Web)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Build Identity Silo Image'
            inputs:
              command: build
              repository: '$(siloImageName)'
              dockerfile: '$(dockerfilePath_Silo)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Identity Web Image'
            inputs:
              command: push
              repository: '$(webImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Identity Silo Image'
            inputs:
              command: push
              repository: '$(siloImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

  - stage: Migrate
    displayName: 'Apply Database Migrations'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: ApplyMigrations
        displayName: 'Apply EF Core Migrations'
        pool:
          name: 'Tylers'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '10.x'

          - script: |
              dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
              echo "Installed dotnet-ef version:"
              $HOME/.dotnet/tools/dotnet-ef --version
            displayName: 'Install EF Core Tools'

          - script: dotnet restore
            displayName: 'Restore NuGet Packages'

          - script: dotnet build TGHarker.Identity.Silo/TGHarker.Identity.Silo.csproj --no-restore
            displayName: 'Build Silo Project'

          - script: |
              echo "Running migration..."
              $HOME/.dotnet/tools/dotnet-ef database update \
                --project TGHarker.Identity.Silo/TGHarker.Identity.Silo.csproj \
                --startup-project TGHarker.Identity.Silo/TGHarker.Identity.Silo.csproj \
                --no-build \
                --verbose
            displayName: 'Apply Migrations'
            env:
              CONNECTION_STRING: $(POSTGRES_CONNECTION_STRING)

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Migrate
    condition: succeeded()
    jobs:
      - deployment: DeployToACA
        displayName: 'Deploy to Azure Container Apps'
        pool:
          name: 'Tylers'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    export PATH="$HOME/.local/bin:$PATH"
                    if ! command -v az &> /dev/null; then
                      echo "Installing pip..."
                      curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
                      python3 /tmp/get-pip.py --user
                      echo "Installing Azure CLI via pip..."
                      python3 -m pip install --user azure-cli
                      echo "##vso[task.prependpath]$HOME/.local/bin"
                    else
                      echo "Azure CLI already installed"
                    fi
                    az version
                  displayName: 'Install Azure CLI'

                - task: AzureCLI@2
                  displayName: 'Deploy Identity Silo'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name identity-silo \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating identity-silo container app..."
                        az containerapp create \
                          --name identity-silo \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress internal \
                          --min-replicas 1 \
                          --max-replicas 3 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service"
                      else
                        echo "Updating identity-silo container app..."
                        az containerapp update \
                          --name identity-silo \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag) \
                          --set-env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service"
                      fi

                - task: AzureCLI@2
                  displayName: 'Deploy Identity Web'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name identity-web \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating identity-web container app..."
                        az containerapp create \
                          --name identity-web \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(webImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress external \
                          --min-replicas 1 \
                          --max-replicas 5 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service" \
                            "SUPERADMIN_USERNAME=$(SUPERADMIN_USERNAME)" \
                            "SUPERADMIN_PASSWORD=$(SUPERADMIN_PASSWORD)"
                      else
                        echo "Updating identity-web container app..."
                        az containerapp update \
                          --name identity-web \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(webImageName):$(tag) \
                          --set-env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service" \
                            "SUPERADMIN_USERNAME=$(SUPERADMIN_USERNAME)" \
                            "SUPERADMIN_PASSWORD=$(SUPERADMIN_PASSWORD)"
                      fi

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Checking deployment status..."

                      # Get Web app URL
                      WEB_URL=$(az containerapp show \
                        --name identity-web \
                        --resource-group $(resourceGroup) \
                        --query "properties.configuration.ingress.fqdn" -o tsv)

                      echo "Identity Web URL: https://$WEB_URL"

                      # Check silo status
                      SILO_STATUS=$(az containerapp show \
                        --name identity-silo \
                        --resource-group $(resourceGroup) \
                        --query "properties.runningStatus" -o tsv)

                      echo "Identity Silo Status: $SILO_STATUS"
