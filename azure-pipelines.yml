# Azure DevOps Pipeline for TGHarker.Identity
# Builds Docker images and deploys to Azure Container Apps

trigger:
  branches:
    include:
      - master

variables:
  # Container Registry
  acrName: '$(ACR_NAME)'
  acrLoginServer: '$(ACR_LOGIN_SERVER)'

  # Container Apps
  resourceGroup: '$(RESOURCE_GROUP)'
  containerAppEnv: '$(CONTAINER_APP_ENV)'

  # Image names
  webImageName: 'identity-web'
  siloImageName: 'identity-silo'

  # Build configuration
  dockerfilePath_Web: 'TGharker.Identity.Web/Dockerfile'
  dockerfilePath_Silo: 'TGHarker.Identity.Silo/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Images'
    jobs:
      - job: BuildImages
        displayName: 'Build Docker Images'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'

          - task: Docker@2
            displayName: 'Build Identity Web Image'
            inputs:
              command: build
              repository: '$(webImageName)'
              dockerfile: '$(dockerfilePath_Web)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Build Identity Silo Image'
            inputs:
              command: build
              repository: '$(siloImageName)'
              dockerfile: '$(dockerfilePath_Silo)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Identity Web Image'
            inputs:
              command: push
              repository: '$(webImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Identity Silo Image'
            inputs:
              command: push
              repository: '$(siloImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToACA
        displayName: 'Deploy to Azure Container Apps'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy Identity Silo'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name identity-silo \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating identity-silo container app..."
                        az containerapp create \
                          --name identity-silo \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress internal \
                          --min-replicas 1 \
                          --max-replicas 3 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service"
                      else
                        echo "Updating identity-silo container app..."
                        az containerapp update \
                          --name identity-silo \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag)
                      fi

                - task: AzureCLI@2
                  displayName: 'Deploy Identity Web'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name identity-web \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating identity-web container app..."
                        az containerapp create \
                          --name identity-web \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(webImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress external \
                          --min-replicas 1 \
                          --max-replicas 5 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__AzureStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__searchdb-identity=$(POSTGRES_CONNECTION_STRING)" \
                            "Orleans__ClusterId=identity-cluster" \
                            "Orleans__ServiceId=identity-service"
                      else
                        echo "Updating identity-web container app..."
                        az containerapp update \
                          --name identity-web \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(webImageName):$(tag)
                      fi

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Checking deployment status..."

                      # Get Web app URL
                      WEB_URL=$(az containerapp show \
                        --name identity-web \
                        --resource-group $(resourceGroup) \
                        --query "properties.configuration.ingress.fqdn" -o tsv)

                      echo "Identity Web URL: https://$WEB_URL"

                      # Check silo status
                      SILO_STATUS=$(az containerapp show \
                        --name identity-silo \
                        --resource-group $(resourceGroup) \
                        --query "properties.runningStatus" -o tsv)

                      echo "Identity Silo Status: $SILO_STATUS"
